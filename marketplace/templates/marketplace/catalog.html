{% extends "marketplace/base_marketplace.html" %}
{% load static %}

{% block marketplace_title %}Browse Products{% endblock %}
{% block marketplace_header %}Browse Products{% endblock %}
{% block marketplace_subtitle %}Discover pet products from the PETio community{% endblock %}

{% block breadcrumbs %}
<li>Browse</li>
{% endblock %}

{% block marketplace_content %}
<!-- Search and Filter Section -->
<form method="get" action=".">
<div class="bg-base-200 rounded-xl p-4 sm:p-6 mb-6">
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-3 lg:gap-4 items-stretch">
        <!-- Search Bar -->
        <div class="lg:col-span-6 min-w-0">
            <!-- On small screens, stack input and button; on >=sm, place them inline -->
            <div class="grid grid-cols-1 sm:grid-cols-[1fr_auto] gap-3">
                <input type="text" name="q" value="{{ q }}"
                       placeholder="Search products..." 
                       class="input input-bordered w-full touch-target" 
                       id="searchInput">
                <button class="btn btn-primary w-full sm:w-auto touch-target" id="searchBtn" type="submit">
                    <i class="fas fa-search"></i>
                    <span class="hidden sm:inline">Search</span>
                </button>
            </div>
        </div>
        
        <!-- Filters trigger + Clear -->
        <div class="lg:col-span-6 flex lg:justify-end gap-2">
            <button type="button" id="openFilters" class="btn btn-outline w-full sm:w-auto touch-target">
                <i class="fas fa-sliders-h"></i>
                <span class="hidden sm:inline ml-1">Filters</span>
            </button>
            <a href="{% url 'marketplace:catalog' %}" class="btn btn-ghost touch-target">Clear Filters</a>
        </div>
    </div>
    
    <!-- Active Filters Display -->
    <div class="mt-4" id="activeFilters" style="display: none;">
        <div class="flex flex-wrap gap-2">
            <span class="text-sm text-base-content/70">Active filters:</span>
            <div id="filterTags" class="flex flex-wrap gap-2"></div>
            <button class="btn btn-ghost btn-xs text-error touch-target" id="clearFilters">
                <i class="fas fa-times mr-1"></i><span class="hidden sm:inline">Clear All</span>
            </button>
        </div>
    </div>

    <!-- Filters Modal -->
    <dialog id="filtersModal" class="modal">
      <div class="modal-box max-w-xl">
        <h3 class="font-bold text-lg flex items-center gap-2">
          <i class="fas fa-sliders-h text-primary"></i>
          Filters
        </h3>
        <div class="mt-4 space-y-4">
          <!-- Category Filter -->
          <div class="form-control">
            <label class="label"><span class="label-text">Category</span></label>
            <select class="select select-bordered w-full" id="categoryFilter" name="category">
                <option value="">All Categories</option>
                {% for c in categories %}
                <option value="{{ c.slug }}" {% if c.slug == category_slug %}selected{% endif %}>{{ c.name }}</option>
                {% endfor %}
            </select>
          </div>
          <!-- Near (Seller Location) -->
          <div class="form-control">
            <label class="label"><span class="label-text">Near</span></label>
            <input type="text" class="input input-bordered w-full" id="nearFilter" name="near" value="{{ near }}" placeholder="City or area">
            <div class="text-xs opacity-60 mt-1">Matches seller profile location.</div>
          </div>
          <!-- Price Range -->
          <div class="form-control">
            <label class="label"><span class="label-text">Price</span></label>
            <!-- Hidden inputs map the selected range to backend GET params -->
            <input type="hidden" id="priceMinInput" name="price_min" value="{{ price_min }}">
            <input type="hidden" id="priceMaxInput" name="price_max" value="{{ price_max }}">
            <select class="select select-bordered w-full" id="priceFilter">
                <option value="" {% if not price_min and not price_max %}selected{% endif %}>Any Price</option>
                <option value="0-25" {% if price_max == '25' %}{% if not price_min or price_min == '0' %}selected{% endif %}{% endif %}>Under ₱25</option>
                <option value="25-50" {% if price_min == '25' and price_max == '50' %}selected{% endif %}>₱25 - ₱50</option>
                <option value="50-100" {% if price_min == '50' and price_max == '100' %}selected{% endif %}>₱50 - ₱100</option>
                <option value="100+" {% if price_min == '100' %}{% if not price_max %}selected{% endif %}{% endif %}>Over ₱100</option>
            </select>
          </div>
          <!-- Condition -->
          <div class="form-control">
            <label class="label"><span class="label-text">Condition</span></label>
            <select class="select select-bordered w-full" id="conditionFilter" name="condition">
                <option value="" {% if not condition %}selected{% endif %}>Any Condition</option>
                <option value="new" {% if condition == 'new' %}selected{% endif %}>New</option>
                <option value="used" {% if condition == 'used' %}selected{% endif %}>Used</option>
            </select>
            <div class="text-xs opacity-60 mt-1">Applied when listings include condition.</div>
          </div>
          <!-- Sort By -->
          <div class="form-control">
            <label class="label"><span class="label-text">Sort By</span></label>
            <select class="select select-bordered w-full" id="sortFilter" name="sort">
                <option value="newest" {% if sort == 'newest' %}selected{% endif %}>Newest First</option>
                <option value="price_asc" {% if sort == 'price_asc' %}selected{% endif %}>Price: Low to High</option>
                <option value="price_desc" {% if sort == 'price_desc' %}selected{% endif %}>Price: High to Low</option>
                <option value="popular" disabled>Most Popular (coming soon)</option>
            </select>
          </div>
        </div>
        <div class="modal-action">
          <button type="button" class="btn btn-ghost" id="clearFiltersModal">Clear</button>
          <form method="dialog">
            <button class="btn btn-primary">Close</button>
          </form>
        </div>
      </div>
      <form method="dialog" class="modal-backdrop">
        <button>close</button>
      </form>
    </dialog>

</div>
</form>

<!-- Mobile-only sticky Filters bar -->
<div class="md:hidden fixed bottom-0 left-0 right-0 z-40 bg-base-100/95 backdrop-blur border-t border-base-300" style="padding-bottom: env(safe-area-inset-bottom);">
  <div class="container mx-auto px-4 py-3">
    <div class="flex items-center gap-3">
      <button type="button" id="openFiltersMobile" class="btn btn-primary btn-block flex-1 touch-target">
        <i class="fas fa-sliders-h"></i>
        <span class="ml-1">Filters</span>
      </button>
      <button type="button" id="clearFiltersMobile" class="btn btn-ghost touch-target">
        <i class="fas fa-times"></i>
        <span class="ml-1">Clear</span>
      </button>
    </div>
  </div>
</div>
<!-- Spacer to prevent overlap by the sticky bar on mobile -->
<div class="h-20 md:hidden"></div>

<!-- Results Summary -->
<div class="flex flex-col sm:flex-row sm:justify-between gap-3 sm:items-center mb-6">
    <div class="text-base-content/70 order-2 sm:order-1">
        <span id="resultsCount">{{ page_obj.paginator.count }}</span> products found
    </div>
    <div class="flex items-center gap-2 order-1 sm:order-2">
        <span class="text-sm text-base-content/70">View:</span>
        <div class="btn-group">
            <button class="btn sm:btn-sm btn-active touch-target" id="gridView">
                <i class="fas fa-th"></i>
            </button>
            <button class="btn sm:btn-sm touch-target" id="listView">
                <i class="fas fa-list"></i>
            </button>
        </div>
    </div>
</div>

<!-- Server-rendered Product Grid (uses listings from view) -->
{% if listings and listings|length > 0 %}
<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3 sm:gap-4 lg:gap-6 mb-8" id="productGrid">
    {% for item in listings %}
    <div class="card bg-base-100 shadow-lg hover:shadow-xl transition-all duration-300 rounded-xl">
        <!-- Product Image -->
        <figure class="relative">
            {% if item.main_image %}
            <img src="{{ item.main_image.url }}" alt="{{ item.title }}" class="w-full h-40 sm:h-48 xl:h-56 object-cover rounded-t-xl" loading="lazy">
            {% else %}
            <img src="{% static 'img/placeholder.svg' %}" alt="{{ item.title }}" class="w-full h-40 sm:h-48 xl:h-56 object-cover rounded-t-xl" loading="lazy">
            {% endif %}
            {% if item.quantity == 0 %}
            <div class="badge badge-error absolute top-2 right-2">Out of Stock</div>
            {% elif item.quantity <= 2 %}
            <div class="badge badge-warning absolute top-2 right-2">Only {{ item.quantity }} left</div>
            {% else %}
            <div class="badge badge-success absolute top-2 right-2">In Stock</div>
            {% endif %}
        </figure>
        <div class="card-body p-3 sm:p-4">
            <div class="badge badge-outline badge-sm mb-2">{% if item.category %}{{ item.category.name }}{% else %}Uncategorized{% endif %}</div>
            <h3 class="card-title text-base sm:text-lg font-semibold line-clamp-2 break-words">{{ item.title }}</h3>
            <div class="flex justify-between items-center mt-2">
                <div class="text-base sm:text-lg font-bold text-primary">₱{{ item.price }}</div>
                <div class="text-xs sm:text-sm text-base-content/70">{{ item.quantity }} available</div>
            </div>
            <div class="flex items-center gap-2 mt-2 text-xs sm:text-sm text-base-content/70">
                <div class="avatar placeholder">
                    <div class="bg-neutral text-neutral-content rounded-full w-6">
                        <span class="text-xs">{{ item.seller.username|first|upper }}</span>
                    </div>
                </div>
                <span>@{{ item.seller.username }}</span>
                {% if item.seller_rating_count %}
                <span class="ml-2 flex items-center gap-1">
                    <i class="fas fa-star text-yellow-400"></i>
                    <span>{{ item.seller_avg_rating|floatformat:1 }}</span>
                    <span class="opacity-60">({{ item.seller_rating_count }})</span>
                </span>
                {% else %}
                <span class="ml-2 opacity-60">No ratings yet</span>
                {% endif %}
            </div>
            {% url 'marketplace:listing_detail' item.pk as view_url_local %}
            {% url 'marketplace:messages' as message_url_local %}
            {% include 'marketplace/components/card_actions.html' with view_url=view_url_local message_url=message_url_local view_label_long='View Details' view_label_short='View' %}
        </div>
    </div>
    {% endfor %}
</div>

<!-- Pagination -->
<div class="flex justify-center mt-8">
    <div class="join">
        {% if page_obj.has_previous %}
            <a class="join-item btn touch-target" href="?{{ qs_no_page }}&page={{ page_obj.previous_page_number }}">
                <i class="fas fa-chevron-left"></i>
            </a>
        {% else %}
            <button class="join-item btn touch-target" disabled>
                <i class="fas fa-chevron-left"></i>
            </button>
        {% endif %}
        <span class="join-item btn btn-active touch-target">{{ page_obj.number }} / {{ page_obj.paginator.num_pages }}</span>
        {% if page_obj.has_next %}
            <a class="join-item btn touch-target" href="?{{ qs_no_page }}&page={{ page_obj.next_page_number }}">
                <i class="fas fa-chevron-right"></i>
            </a>
        {% else %}
            <button class="join-item btn touch-target" disabled>
                <i class="fas fa-chevron-right"></i>
            </button>
        {% endif %}
    </div>
</div>
{% else %}
<!-- No Results State (server-driven) -->
<div class="text-center py-12" id="noResultsState">
    <div class="text-6xl text-base-content/30 mb-4">
        <i class="fas fa-search"></i>
    </div>
    <h3 class="text-xl font-semibold mb-2">No products found</h3>
    <p class="text-base-content/70 mb-4">Try adjusting your search or filters</p>
    <a class="btn btn-primary" href="{% url 'marketplace:catalog' %}">Reset Search</a>
</div>
{% endif %}

<!-- Loading State (Hidden by default) -->
<div class="text-center py-12 hidden" id="loadingState">
    <div class="loading loading-spinner loading-lg text-primary"></div>
    <p class="mt-4 text-base-content/70">Loading products...</p>
</div>

<!-- No Results State (Hidden by default) -->
<div class="text-center py-12 hidden" id="noResultsState">
    <div class="text-6xl text-base-content/30 mb-4">
        <i class="fas fa-search"></i>
    </div>
    <h3 class="text-xl font-semibold mb-2">No products found</h3>
    <p class="text-base-content/70 mb-4">Try adjusting your search or filters</p>
    <button class="btn btn-primary" id="resetSearch">Reset Search</button>
</div>

<!-- Quick Stats -->
<div class="stats shadow mt-8 w-full">
    <div class="stat">
        <div class="stat-figure text-primary">
            <i class="fas fa-box text-2xl"></i>
        </div>
        <div class="stat-title">Total Products</div>
        <div class="stat-value text-primary">{{ global_stats.total_products|default:0 }}</div>
        <div class="stat-desc">{{ global_stats.new_products_week|default:0 }} new this week</div>
    </div>
    
    <div class="stat">
        <div class="stat-figure text-secondary">
            <i class="fas fa-users text-2xl"></i>
        </div>
        <div class="stat-title">Active Sellers</div>
        <div class="stat-value text-secondary">{{ global_stats.active_sellers|default:0 }}</div>
        <div class="stat-desc">{{ global_stats.new_sellers_week|default:0 }} new sellers</div>
    </div>
    
    <div class="stat">
        <div class="stat-figure text-accent">
            <i class="fas fa-tags text-2xl"></i>
        </div>
        <div class="stat-title">Categories</div>
        <div class="stat-value text-accent">{{ global_stats.categories|default:0 }}</div>
        <div class="stat-desc">Pet products only</div>
    </div>
</div>
{% endblock %}

{% block marketplace_scripts %}
<script>
/**
 * Marketplace Catalog JavaScript (server-driven)
 * Submits the GET form on changes; no client-side data loading.
 */
class MarketplaceCatalog {
    constructor() {
        this.currentView = 'grid';
        this.init();
    }
    /** Initialize event listeners for server-driven filtering */
    init() {
        const getForm = document.querySelector('form[method="get"]');
        const searchInput = document.getElementById('searchInput');
        const searchBtn = document.getElementById('searchBtn');
        if (searchBtn) {
            // Let the form submit naturally on click
            searchBtn.addEventListener('click', () => {});
        }
        if (searchInput) {
            // Native submit on Enter
            searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') { /* native submit */ }
            });
        }
        // Filter changes -> submit form
        const categoryEl = document.getElementById('categoryFilter');
        const priceEl = document.getElementById('priceFilter');
        const sortEl = document.getElementById('sortFilter');
        const conditionEl = document.getElementById('conditionFilter');
        const nearEl = document.getElementById('nearFilter');
        if (categoryEl) categoryEl.addEventListener('change', () => { if (getForm) getForm.submit(); });
        if (priceEl) priceEl.addEventListener('change', (e) => {
            const v = e.target.value;
            const minInput = document.getElementById('priceMinInput');
            const maxInput = document.getElementById('priceMaxInput');
            let min = '', max = '';
            if (v === '0-25') { min = ''; max = '25'; }
            else if (v === '25-50') { min = '25'; max = '50'; }
            else if (v === '50-100') { min = '50'; max = '100'; }
            else if (v === '100+') { min = '100'; max = ''; }
            else { min = ''; max = ''; }
            if (minInput) minInput.value = min;
            if (maxInput) maxInput.value = max;
            if (getForm) getForm.submit();
        });
        if (sortEl) sortEl.addEventListener('change', () => { if (getForm) getForm.submit(); });
        if (conditionEl) conditionEl.addEventListener('change', () => { if (getForm) getForm.submit(); });
        if (nearEl) {
            // Submit on Enter; allow manual closing otherwise
            nearEl.addEventListener('keypress', (e) => { if (e.key === 'Enter') { /* native submit */ } });
            nearEl.addEventListener('change', () => { if (getForm) getForm.submit(); });
        }
        // View switching (cosmetic only)
        const gridBtn = document.getElementById('gridView');
        const listBtn = document.getElementById('listView');
        const productGrid = document.getElementById('productGrid');
        if (gridBtn) gridBtn.addEventListener('click', (e) => { e.preventDefault(); this.switchView('grid', productGrid, gridBtn, listBtn); });
        if (listBtn) listBtn.addEventListener('click', (e) => { e.preventDefault(); this.switchView('list', productGrid, gridBtn, listBtn); });
        // Clear all filters
        const clearFiltersBtn = document.getElementById('clearFilters');
        if (clearFiltersBtn) clearFiltersBtn.addEventListener('click', () => { this.clearAllFilters(); if (getForm) getForm.submit(); });
        // Modal controls
        const openFiltersBtn = document.getElementById('openFilters');
        const filtersModal = document.getElementById('filtersModal');
        const clearFiltersModal = document.getElementById('clearFiltersModal');
        if (openFiltersBtn && filtersModal) {
            openFiltersBtn.addEventListener('click', () => filtersModal.showModal());
        }
        if (clearFiltersModal) {
            clearFiltersModal.addEventListener('click', () => {
                this.clearAllFilters();
                if (filtersModal && typeof filtersModal.close === 'function' && filtersModal.open) {
                    filtersModal.close();
                }
                if (getForm) getForm.submit();
            });
        }
        // Mobile sticky bar
        const openFiltersMobile = document.getElementById('openFiltersMobile');
        const clearFiltersMobile = document.getElementById('clearFiltersMobile');
        if (openFiltersMobile && filtersModal) {
            openFiltersMobile.addEventListener('click', () => filtersModal.showModal());
        }
        if (clearFiltersMobile) {
            clearFiltersMobile.addEventListener('click', () => { this.clearAllFilters(); if (getForm) getForm.submit(); });
        }
    }
    /** Reset all form controls to defaults */
    clearAllFilters() {
        const cat = document.getElementById('categoryFilter');
        const price = document.getElementById('priceFilter');
        const sort = document.getElementById('sortFilter');
        const condition = document.getElementById('conditionFilter');
        const nearInput = document.getElementById('nearFilter');
        const minInput = document.getElementById('priceMinInput');
        const maxInput = document.getElementById('priceMaxInput');
        const searchInput = document.getElementById('searchInput');
        if (cat) cat.value = '';
        if (price) price.value = '';
        if (sort) sort.value = 'newest';
        if (minInput) minInput.value = '';
        if (maxInput) maxInput.value = '';
        if (searchInput) searchInput.value = '';
        if (condition) condition.value = '';
        if (nearInput) nearInput.value = '';
    }
    /** Toggle layout (cosmetic only) */
    switchView(viewType, productGrid, gridBtn, listBtn) {
        if (!productGrid || !gridBtn || !listBtn) return;
        if (viewType === 'grid') {
            gridBtn.classList.add('btn-active');
            listBtn.classList.remove('btn-active');
            productGrid.className = 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 mb-8';
        } else {
            listBtn.classList.add('btn-active');
            gridBtn.classList.remove('btn-active');
            productGrid.className = 'space-y-4 mb-8';
        }
    }
}
// Init
window.addEventListener('DOMContentLoaded', () => { window.catalog = new MarketplaceCatalog(); });
// Lightweight CSS helpers
const style = document.createElement('style');
style.textContent = `
    .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    @media (max-width: 640px) { .touch-target { min-height: 44px; padding-left: 1rem; padding-right: 1rem; } }
`;
document.head.appendChild(style);
</script>
{% endblock %}